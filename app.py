import streamlit as st
import pandas as pd
import plotly.express as px
import plotly.graph_objects as go
from supabase import create_client
from datetime import datetime

st.set_page_config(page_title="ìš°ë¦¬ì€í–‰ ê¸ˆë¦¬ ê²½ìŸë ¥ ëª¨ë‹ˆí„°", page_icon="ğŸ¦", layout="wide")

st.markdown("""
<style>
    @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@400;500;600;700;800&display=swap');
    html, body, [class*="css"] { font-family: 'Noto Sans KR', sans-serif; }
    .summary-banner { background: linear-gradient(135deg, #1e3a8a 0%, #1d4ed8 100%); border-radius: 14px; padding: 22px 28px; color: white; margin-bottom: 24px; }
    .summary-banner .date { font-size: 12px; opacity: .7; margin-bottom: 6px; }
    .summary-banner .headline { font-size: 20px; font-weight: 800; line-height: 1.4; }
    .summary-banner .sub { font-size: 13px; opacity: .85; margin-top: 8px; }
    .insight-box { background: #f0f7ff; border-left: 4px solid #1d4ed8; border-radius: 8px; padding: 14px 18px; margin-top: 16px; font-size: 13px; color: #1e293b; line-height: 1.8; }
    .insight-box b { color: #1d4ed8; }
    .desc-box { background: #f8fafc; border: 1px solid #e2e8f0; border-radius: 8px; padding: 12px 16px; margin-bottom: 16px; font-size: 13px; color: #475569; line-height: 1.7; }
    .section-title { font-size: 15px; font-weight: 700; color: #1e293b; margin: 20px 0 10px; border-left: 4px solid #1d4ed8; padding-left: 10px; }
    .metric-card { background: white; border: 1px solid #e2e8f0; border-radius: 10px; padding: 16px 20px; text-align: center; }
    .metric-label { font-size: 11px; color: #94a3b8; margin-bottom: 6px; font-weight: 600; }
    .metric-value { font-size: 26px; font-weight: 800; color: #1d4ed8; }
    .metric-sub { font-size: 11px; color: #94a3b8; margin-top: 3px; }
    div[data-testid="stSidebar"] { background: #1e2d45; }
    div[data-testid="stSidebar"] * { color: #e2e8f0 !important; }
    /* ë©€í‹°ì…€ë ‰íŠ¸ íƒœê·¸ íŒŒìŠ¤í…” ë¸”ë£¨ */
    span[data-baseweb="tag"] {
        background-color: #bfdbfe !important;
        border: 1px solid #93c5fd !important;
    }
    span[data-baseweb="tag"] span {
        color: #1e3a8a !important;
        font-weight: 600 !important;
    }
    span[data-baseweb="tag"] svg {
        fill: #1e3a8a !important;
    }
</style>
""", unsafe_allow_html=True)

PERIOD_ORDER = [1, 3, 6, 12, 24, 36]

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# Supabase ì—°ê²°
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
@st.cache_resource
def get_supabase():
    return create_client(st.secrets["SUPABASE_URL"], st.secrets["SUPABASE_KEY"])

supabase = get_supabase()

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# ë°ì´í„° ë¡œë“œ
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
@st.cache_data(ttl=300)
def load_comparison_data():
    response = supabase.rpc("get_better_than_woori_final", {}).execute()
    return pd.DataFrame(response.data)

@st.cache_data(ttl=300)
def load_history_data():
    response = supabase.table("finance_data").select(
        "collected_at, kor_co_nm, fin_prdt_nm, save_trm, intr_rate, intr_rate2, spcl_cnd, product_type, rsrv_type_nm"
    ).execute()
    df = pd.DataFrame(response.data)
    df["collected_at"] = pd.to_datetime(df["collected_at"])
    return df

try:
    df = load_comparison_data()
except Exception as e:
    st.error(f"ë°ì´í„° ë¡œë”© ì‹¤íŒ¨: {e}")
    st.stop()

try:
    hist_df = load_history_data()
except Exception as e:
    st.warning(f"ì¶”ì´ ë°ì´í„° ë¡œë”© ì‹¤íŒ¨: {e}")
    hist_df = pd.DataFrame()

COL = {
    "type":       df.columns[0],
    "woori_prod": df.columns[1],
    "period":     df.columns[2],
    "bank":       df.columns[3],
    "bank_prod":  df.columns[4],
    "woori_base": df.columns[5],
    "woori_max":  df.columns[6],
    "bank_base":  df.columns[7],
    "bank_max":   df.columns[8],
    "rate_diff":  df.columns[9],
    "difficulty": df.columns[10],
    "benefit":    df.columns[11],
}

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# ì‚¬ì´ë“œë°” í•„í„°
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
with st.sidebar:
    st.markdown("## ğŸ” í•„í„°")
    st.markdown("---")
    sel_type   = st.multiselect("ìƒí’ˆ íƒ€ì…",       sorted(df[COL["type"]].dropna().unique()),   default=sorted(df[COL["type"]].dropna().unique()))
    sel_period = st.multiselect("ì €ì¶• ê¸°ê°„ (ê°œì›”)", sorted(df[COL["period"]].dropna().unique()), default=sorted(df[COL["period"]].dropna().unique()))
    sel_bank   = st.multiselect("íƒ€í–‰ëª…",           sorted(df[COL["bank"]].dropna().unique()),   default=sorted(df[COL["bank"]].dropna().unique()))
    st.markdown("---")
    if st.button("ğŸ”„ ìƒˆë¡œê³ ì¹¨"):
        st.cache_data.clear()
        st.rerun()

mask = (
    df[COL["type"]].isin(sel_type) &
    df[COL["period"]].isin(sel_period) &
    df[COL["bank"]].isin(sel_bank)
)
fdf = df[mask].copy()
fdf_sorted = fdf.sort_values(COL["rate_diff"], ascending=False).reset_index(drop=True)

today     = datetime.now().strftime("%Yë…„ %mì›” %dì¼")
max_diff  = fdf[COL["rate_diff"]].max() if len(fdf) > 0 else 0
max_row   = fdf.loc[fdf[COL["rate_diff"]].idxmax()] if len(fdf) > 0 else None
high_risk = len(fdf[fdf[COL["rate_diff"]] >= 0.3])

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# ìƒë‹¨ ë°°ë„ˆ
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
if max_row is not None:
    st.markdown(f"""
    <div class="summary-banner">
        <div class="date">ğŸ“… {today} ê¸°ì¤€</div>
        <div class="headline">ğŸš¨ ìš°ë¦¬ì€í–‰ ëŒ€ë¹„ ìµœëŒ€ {max_diff:.2f}%p ë†’ì€ íƒ€í–‰ ìƒí’ˆ {len(fdf)}ê°œ ë°œê²¬</div>
        <div class="sub">ê³ ìœ„í—˜ ìƒí’ˆ(ê¸ˆë¦¬ì°¨ 0.3%pâ†‘) {high_risk}ê°œ Â· ê°€ì¥ ìœ„í˜‘ì : {max_row[COL['bank']]} '{max_row[COL['bank_prod']]}'</div>
    </div>
    """, unsafe_allow_html=True)

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# íƒ­ êµ¬ì„±
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
tabs = st.tabs([
    "ğŸ  ì¢…í•© í˜„í™©",
    "ğŸ—ºï¸ ê²½ìŸ êµ¬ì¡°",
    "ğŸ“ˆ ê¸ˆë¦¬ ë³€ë™ ì¶”ì´",
    "ğŸ“‹ ì „ì²´ ë°ì´í„°",
])

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# TAB 1: ì¢…í•© í˜„í™©
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
with tabs[0]:
    st.markdown("### ğŸ  ì¢…í•© í˜„í™©")
    st.markdown('<div class="desc-box">ìš°ë¦¬ì€í–‰ë³´ë‹¤ ê¸ˆë¦¬ê°€ ë†’ì€ íƒ€í–‰ ìƒí’ˆì„ ê¸ˆë¦¬ì°¨ ìˆœìœ¼ë¡œ í™•ì¸í•©ë‹ˆë‹¤. ê° ìƒí’ˆì„ í´ë¦­í•˜ë©´ ê¸°ê°„ë³„ ê¸ˆë¦¬ ë³€ë™ ì¶”ì´ë¥¼ í™•ì¸í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</div>', unsafe_allow_html=True)

    # â”€â”€ í•µì‹¬ ì§€í‘œ â”€â”€
    c1, c2, c3, c4 = st.columns(4)
    for col, (label, value, sub) in zip([c1,c2,c3,c4], [
        ("ì´ ê²½ìŸ ìƒí’ˆ",  f"{len(fdf)}ê°œ",         "ìš°ë¦¬ì€í–‰ë³´ë‹¤ ê¸ˆë¦¬ ë†’ì€ ìƒí’ˆ"),
        ("ìµœëŒ€ ê¸ˆë¦¬ì°¨",   f"{max_diff:.2f}%p",      max_row[COL['bank']] if max_row is not None else "-"),
        ("ê³ ìœ„í—˜ ìƒí’ˆ",   f"{high_risk}ê°œ",         "ê¸ˆë¦¬ì°¨ 0.3%p ì´ìƒ"),
        ("ë¹„êµ íƒ€í–‰ ìˆ˜",  f"{fdf[COL['bank']].nunique()}ê°œ", "ì€í–‰"),
    ]):
        with col:
            st.markdown(f'<div class="metric-card"><div class="metric-label">{label}</div><div class="metric-value">{value}</div><div class="metric-sub">{sub}</div></div>', unsafe_allow_html=True)

    st.markdown("")

    import re

    def strip_deposit_type(name):
        """ìƒí’ˆëª…ì—ì„œ (ììœ ì ë¦½ì‹) / (ì •ì•¡ì ë¦½ì‹) ë“± ê´„í˜¸ íŒ¨í„´ ì œê±°"""
        return re.sub(r"\s*\(ììœ ì ë¦½ì‹\)|\s*\(ì •ì•¡ì ë¦½ì‹\)", "", name).strip()

    def get_deposit_type(row):
        """ì ë¦½ ë°©ì‹ ì¶”ì¶œ â€” 2ê°€ì§€ ì¼€ì´ìŠ¤ ëª¨ë‘ ì²˜ë¦¬
        ì¼€ì´ìŠ¤ A: fin_prdt_nmì— ê´„í˜¸ë¡œ í¬í•¨ëœ ê²½ìš°
        ì¼€ì´ìŠ¤ B: rsrv_type_nm ë³„ë„ ì»¬ëŸ¼ì— ìˆëŠ” ê²½ìš°
        """
        # 1ìˆœìœ„: rsrv_type_nm ì»¬ëŸ¼ (ì¼€ì´ìŠ¤ B)
        rsrv = row.get("rsrv_type_nm", None)
        if pd.notna(rsrv) and rsrv:
            if "ììœ " in str(rsrv):
                return "ììœ "
            elif "ì •ì•¡" in str(rsrv):
                return "ì •ì•¡"
        # 2ìˆœìœ„: ìƒí’ˆëª… ê´„í˜¸ íŒŒì‹± (ì¼€ì´ìŠ¤ A)
        nm = str(row.get("fin_prdt_nm", ""))
        if "ììœ ì ë¦½ì‹" in nm:
            return "ììœ "
        elif "ì •ì•¡ì ë¦½ì‹" in nm:
            return "ì •ì•¡"
        return "ì¼ë°˜"

    # â”€â”€ ìƒí’ˆëª… ê¸°ì¤€ ì¤‘ë³µ ì œê±°: ê´„í˜¸ ì œê±° í›„ ê¸ˆë¦¬ì°¨ ê°€ì¥ ë†’ì€ ê¸°ê°„ ëŒ€í‘œê°’ìœ¼ë¡œ â”€â”€
    fdf_dedup = fdf.copy()
    fdf_dedup["_clean_prod"] = fdf_dedup[COL["bank_prod"]].apply(strip_deposit_type)

    dedup_df = (
        fdf_dedup.sort_values(COL["rate_diff"], ascending=False)
        .drop_duplicates(subset=[COL["bank"], "_clean_prod"], keep="first")
        .reset_index(drop=True)
    )

    # â”€â”€ ì„¸ì…˜ ìƒíƒœ: ì „ì²´ ë³´ê¸° í† ê¸€ â”€â”€
    if "show_all_products" not in st.session_state:
        st.session_state["show_all_products"] = False

    TOP_N = 5
    display_list = dedup_df if st.session_state["show_all_products"] else dedup_df.head(TOP_N)

    st.markdown('<div class="section-title">ğŸ“‹ ê¸ˆë¦¬ì°¨ ë†’ì€ ìˆœ ìƒí’ˆ ë­í‚¹</div>', unsafe_allow_html=True)

    # â”€â”€ ìƒ‰ìƒ íŒ”ë ˆíŠ¸ â”€â”€
    # ììœ ì ë¦½ì‹ or ì¼ë°˜: íŒŒë‘ ê³„ì—´ ì‹¤ì„ 
    BLUE_COLORS = {
        1:  "#bfdbfe",
        3:  "#60a5fa",
        6:  "#3b82f6",
        12: "#1d4ed8",
        24: "#1e3a8a",
        36: "#172554",
    }
    # ì •ì•¡ì ë¦½ì‹: ì´ˆë¡ ê³„ì—´ ì ì„ 
    GREEN_COLORS = {
        1:  "#bbf7d0",
        3:  "#4ade80",
        6:  "#22c55e",
        12: "#16a34a",
        24: "#15803d",
        36: "#14532d",
    }

    for i, (_, row) in enumerate(display_list.iterrows()):
        bank_nm    = row[COL["bank"]]
        prod_nm_raw = row[COL["bank_prod"]]
        prod_nm    = strip_deposit_type(prod_nm_raw)   # í—¤ë”ì—” ê´„í˜¸ ì œê±°í•œ ì´ë¦„
        bank_max   = row[COL["bank_max"]]
        rate_diff  = row[COL["rate_diff"]]
        rank       = i + 1

        label = f"**{rank}ìœ„** Â· {bank_nm}  |  {prod_nm}  |  ìµœê³ ê¸ˆë¦¬ **{bank_max:.2f}%**  |  ê¸ˆë¦¬ì°¨ **+{rate_diff:.2f}%p**"

        with st.expander(label, expanded=False):
            if hist_df.empty:
                st.info("ì¶”ì´ ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.")
            else:
                # ê´„í˜¸ í¬í•¨ëœ ì›ë˜ ì´ë¦„ë“¤ ì „ë¶€ ë§¤ì¹­ (ììœ /ì •ì•¡ ë‘˜ ë‹¤ í¬í•¨)
                prod_hist = hist_df[
                    (hist_df["kor_co_nm"] == bank_nm) &
                    (hist_df["fin_prdt_nm"].apply(strip_deposit_type) == prod_nm)
                ].copy()
                prod_hist["_deposit_type"] = prod_hist.apply(get_deposit_type, axis=1)

                if prod_hist.empty:
                    st.info("í•´ë‹¹ ìƒí’ˆì˜ ê¸ˆë¦¬ ì¶”ì´ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.")
                else:
                    available_periods = sorted(prod_hist["save_trm"].dropna().unique().tolist())
                    deposit_types     = sorted(prod_hist["_deposit_type"].unique().tolist())

                    # â”€â”€ ê¸°ê°„ Ã— ì ë¦½ë°©ì‹ ë©€í‹°ë¼ì¸ ê·¸ë˜í”„ â”€â”€
                    fig_exp = go.Figure()
                    for dtype in deposit_types:
                        dtype_df = prod_hist[prod_hist["_deposit_type"] == dtype]
                        color_map  = GREEN_COLORS if dtype == "ì •ì•¡" else BLUE_COLORS
                        line_dash  = "dot" if dtype == "ì •ì•¡" else "solid"
                        type_label = f" ({dtype})" if len(deposit_types) > 1 else ""

                        for trm in available_periods:
                            trm_df = dtype_df[dtype_df["save_trm"] == trm].sort_values("collected_at")
                            if trm_df.empty:
                                continue
                            color = color_map.get(int(trm), "#64748b")
                            fig_exp.add_trace(go.Scatter(
                                x=trm_df["collected_at"],
                                y=trm_df["intr_rate2"],
                                mode="lines+markers",
                                name=f"{int(trm)}ê°œì›”{type_label}",
                                line=dict(color=color, width=2, dash=line_dash),
                                marker=dict(size=5),
                            ))

                    # Yì¶• ì—¬ìœ  ê³„ì‚° (25%ë¡œ í™•ëŒ€ â€” ë²”ë¡€ ê³µê°„ í™•ë³´)
                    all_rates = prod_hist["intr_rate2"].dropna()
                    y_min = all_rates.min()
                    y_max = all_rates.max()
                    y_pad = (y_max - y_min) * 0.25 if y_max != y_min else 0.15

                    fig_exp.update_layout(
                        plot_bgcolor="white", paper_bgcolor="white",
                        legend=dict(orientation="h", y=1.18, x=1, xanchor="right", title_text="ê¸°ê°„ Â· ë°©ì‹"),
                        yaxis=dict(
                            ticksuffix="%", gridcolor="#f1f5f9", title="ìµœëŒ€ê¸ˆë¦¬ (%)",
                            range=[y_min - y_pad, y_max + y_pad],
                        ),
                        xaxis=dict(title="ìˆ˜ì§‘ ë‚ ì§œ", gridcolor="#f1f5f9"),
                        margin=dict(l=10, r=10, t=40, b=10),
                        height=360,
                        title=dict(text=f"{bank_nm} Â· {prod_nm} â€” ê¸°ê°„ë³„ ìµœëŒ€ê¸ˆë¦¬ ì¶”ì´", font=dict(size=13), x=0),
                    )
                    st.plotly_chart(fig_exp, use_container_width=True)

                    # â”€â”€ ê²°ê³¼ ìš”ì•½ (st ê¸°ë³¸ ë¬¸ë²•) â”€â”€
                    st.divider()

                    # ì ë¦½ë°©ì‹ Ã— ê¸°ê°„ ì¡°í•©ìœ¼ë¡œ ì»¬ëŸ¼ êµ¬ì„±
                    summary_items = []
                    for dtype in deposit_types:
                        for trm in available_periods:
                            trm_df = prod_hist[
                                (prod_hist["_deposit_type"] == dtype) &
                                (prod_hist["save_trm"] == trm)
                            ].sort_values("collected_at")
                            if not trm_df.empty:
                                summary_items.append((dtype, trm, trm_df))

                    sum_cols = st.columns(len(summary_items)) if summary_items else st.columns(1)
                    for ci, (dtype, trm, trm_df) in enumerate(summary_items):
                        first_r  = trm_df["intr_rate2"].iloc[0]
                        latest_r = trm_df["intr_rate2"].iloc[-1]
                        delta    = latest_r - first_r
                        type_label = f" ({dtype})" if len(deposit_types) > 1 else ""
                        with sum_cols[ci]:
                            st.metric(
                                label=f"{int(trm)}ê°œì›”{type_label}",
                                value=f"{latest_r:.2f}%",
                                delta=f"{delta:+.2f}%p",
                            )

                    # ë°ì´í„° ìˆ˜ì§‘ ê¸°ê°„
                    date_min = prod_hist["collected_at"].min().strftime("%Y-%m-%d")
                    date_max = prod_hist["collected_at"].max().strftime("%Y-%m-%d")
                    deposit_label = " Â· ".join([f"{d}ì ë¦½ì‹" if d != "ì¼ë°˜" else "ì¼ë°˜" for d in deposit_types])
                    st.caption(f"ğŸ“… ìˆ˜ì§‘ ê¸°ê°„: {date_min} ~ {date_max}  |  ê¸°ê°„ ìˆ˜: {len(available_periods)}ê°œ  |  ì ë¦½ ë°©ì‹: {deposit_label}")

    st.markdown("")

    # â”€â”€ ì „ì²´ ë³´ê¸° / ì ‘ê¸° ë²„íŠ¼ â”€â”€
    if len(dedup_df) > TOP_N:
        remaining = len(dedup_df) - TOP_N
        if not st.session_state["show_all_products"]:
            if st.button(f"ğŸ“‚ ì „ì²´ ë³´ê¸° (ë‚˜ë¨¸ì§€ {remaining}ê°œ ë” ë³´ê¸°)"):
                st.session_state["show_all_products"] = True
                st.rerun()
        else:
            if st.button("ğŸ”¼ ì ‘ê¸° (ìƒìœ„ 5ê°œë§Œ ë³´ê¸°)"):
                st.session_state["show_all_products"] = False
                st.rerun()

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# TAB 2: ê²½ìŸ êµ¬ì¡°
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
with tabs[1]:
    st.markdown("### ğŸ—ºï¸ ê²½ìŸ êµ¬ì¡°")
    st.markdown('<div class="desc-box">íƒ€í–‰ì´ ì–´ëŠ ì €ì¶• ê¸°ê°„ì— ì§‘ì¤‘ì ìœ¼ë¡œ ê²½ìŸí•˜ëŠ”ì§€ íŒŒì•…í•©ë‹ˆë‹¤. íˆíŠ¸ë§µìœ¼ë¡œ íƒ€í–‰ Ã— ê¸°ê°„ ì¡°í•©ì˜ ê²½ìŸ ê°•ë„ë¥¼ í™•ì¸í•˜ì„¸ìš”.</div>', unsafe_allow_html=True)

    st.markdown('<div class="section-title">íƒ€í–‰ Ã— ì €ì¶•ê¸°ê°„ ê¸ˆë¦¬ì°¨ íˆíŠ¸ë§µ</div>', unsafe_allow_html=True)
    pivot = fdf.groupby([COL["bank"], COL["period"]])[COL["rate_diff"]].max().reset_index()
    pivot_table = pivot.pivot(index=COL["bank"], columns=COL["period"], values=COL["rate_diff"]).fillna(0)
    # ì €ì¶• ê¸°ê°„ ìˆœì„œ ì •ë ¬
    pivot_table = pivot_table.reindex(columns=[p for p in PERIOD_ORDER if p in pivot_table.columns])

    fig_h = px.imshow(pivot_table, color_continuous_scale="Blues",
                      labels=dict(x="ì €ì¶• ê¸°ê°„(ê°œì›”)", y="íƒ€í–‰ëª…", color="ìµœëŒ€ ê¸ˆë¦¬ì°¨(%p)"),
                      text_auto=".2f", aspect="auto")
    fig_h.update_layout(margin=dict(l=10,r=10,t=10,b=10), height=360)
    st.plotly_chart(fig_h, use_container_width=True)

    max_combo = pivot.loc[pivot[COL["rate_diff"]].idxmax()]
    st.markdown(f"""
    <div class="insight-box">
        ğŸ“Œ <b>ê²°ê³¼ ìš”ì•½</b><br>
        í˜„ì¬ <b>{max_combo[COL['bank']]}</b>ì˜ <b>{int(max_combo[COL['period']])}ê°œì›”</b> ìƒí’ˆì´ ê¸ˆë¦¬ì°¨ <b>{max_combo[COL['rate_diff']]:.2f}%p</b>ë¡œ ê°€ì¥ ìœ„í˜‘ì ì¸ ì¡°í•©ì…ë‹ˆë‹¤.
    </div>
    """, unsafe_allow_html=True)

    st.markdown('<div class="section-title">ìš°ë¦¬ì€í–‰ ìƒí’ˆë³„ ê²½ìŸ ìƒí’ˆ ìˆ˜</div>', unsafe_allow_html=True)
    vuln = fdf.groupby([COL["woori_prod"], COL["period"]]).size().reset_index(name="ê²½ìŸ ìƒí’ˆ ìˆ˜")
    vuln_pivot = vuln.pivot(index=COL["woori_prod"], columns=COL["period"], values="ê²½ìŸ ìƒí’ˆ ìˆ˜").fillna(0)
    # ì €ì¶• ê¸°ê°„ ìˆœì„œ ì •ë ¬
    vuln_pivot = vuln_pivot.reindex(columns=[p for p in PERIOD_ORDER if p in vuln_pivot.columns])

    fig_v = px.imshow(vuln_pivot, color_continuous_scale="Reds",
                      labels=dict(x="ì €ì¶• ê¸°ê°„(ê°œì›”)", y="ìš°ë¦¬ì€í–‰ ìƒí’ˆ", color="ê²½ìŸ ìƒí’ˆ ìˆ˜"),
                      text_auto=True, aspect="auto")
    fig_v.update_layout(margin=dict(l=10,r=10,t=10,b=10), height=300)
    st.plotly_chart(fig_v, use_container_width=True)

    worst_prod = vuln.loc[vuln["ê²½ìŸ ìƒí’ˆ ìˆ˜"].idxmax()]
    st.markdown(f"""
    <div class="insight-box">
        ğŸ“Œ <b>ê²°ê³¼ ìš”ì•½</b><br>
        <b>{worst_prod[COL['woori_prod']]}</b> <b>{int(worst_prod[COL['period']])}ê°œì›”</b> ìƒí’ˆì´ <b>{int(worst_prod['ê²½ìŸ ìƒí’ˆ ìˆ˜'])}ê°œ</b> íƒ€í–‰ ìƒí’ˆì— ë°€ë¦¬ë©° ê°€ì¥ ì·¨ì•½í•œ êµ¬ê°„ì…ë‹ˆë‹¤.
    </div>
    """, unsafe_allow_html=True)

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# TAB 3: ê¸ˆë¦¬ ë³€ë™ ì¶”ì´
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
with tabs[2]:
    st.markdown("### ğŸ“ˆ ê¸ˆë¦¬ ë³€ë™ ì¶”ì´")
    st.markdown('<div class="desc-box">íŠ¹ì • ìƒí’ˆì˜ ë‚ ì§œë³„ ê¸ˆë¦¬ ë³€ë™ì„ ì¶”ì í•©ë‹ˆë‹¤. ë§¤ì¼ ìˆ˜ì§‘ëœ ë°ì´í„°ë¥¼ ë°”íƒ•ìœ¼ë¡œ ê¸°ë³¸ê¸ˆë¦¬ì™€ ìµœëŒ€ê¸ˆë¦¬ê°€ ì–¸ì œ ì–´ë–»ê²Œ ë°”ë€Œì—ˆëŠ”ì§€ í™•ì¸í•˜ì„¸ìš”.</div>', unsafe_allow_html=True)

    if hist_df.empty:
        st.warning("ì¶”ì´ ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.")
    else:
        col1, col2, col3 = st.columns(3)
        with col1:
            all_banks_hist = sorted(hist_df["kor_co_nm"].dropna().unique().tolist())
            sel_bank_hist  = st.selectbox("ì€í–‰ ì„ íƒ", all_banks_hist, key="hist_bank")
        with col2:
            products_of_bank = sorted(hist_df[hist_df["kor_co_nm"] == sel_bank_hist]["fin_prdt_nm"].dropna().unique().tolist())
            sel_prod_hist    = st.selectbox("ìƒí’ˆ ì„ íƒ", products_of_bank, key="hist_prod")
        with col3:
            periods_of_prod = sorted(hist_df[
                (hist_df["kor_co_nm"] == sel_bank_hist) &
                (hist_df["fin_prdt_nm"] == sel_prod_hist)
            ]["save_trm"].dropna().unique().tolist())
            sel_trm_hist = st.selectbox("ì €ì¶• ê¸°ê°„(ê°œì›”)", periods_of_prod, key="hist_trm")

        trend_df = hist_df[
            (hist_df["kor_co_nm"] == sel_bank_hist) &
            (hist_df["fin_prdt_nm"] == sel_prod_hist) &
            (hist_df["save_trm"] == sel_trm_hist)
        ].sort_values("collected_at").reset_index(drop=True)

        if trend_df.empty:
            st.info("í•´ë‹¹ ì¡°ê±´ì˜ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.")
        else:
            trend_df["base_changed"] = trend_df["intr_rate"].diff().ne(0)
            trend_df["max_changed"]  = trend_df["intr_rate2"].diff().ne(0)
            trend_df["any_changed"]  = trend_df["base_changed"] | trend_df["max_changed"]
            changed_df = trend_df[trend_df["any_changed"] & (trend_df.index > 0)]

            st.markdown('<div class="section-title">ë‚ ì§œë³„ ê¸ˆë¦¬ ì¶”ì´</div>', unsafe_allow_html=True)
            fig_trend = go.Figure()
            fig_trend.add_trace(go.Scatter(
                x=trend_df["collected_at"], y=trend_df["intr_rate"],
                mode="lines+markers", name="ê¸°ë³¸ê¸ˆë¦¬",
                line=dict(color="#93c5fd", width=2), marker=dict(size=5),
            ))
            fig_trend.add_trace(go.Scatter(
                x=trend_df["collected_at"], y=trend_df["intr_rate2"],
                mode="lines+markers", name="ìµœëŒ€ê¸ˆë¦¬",
                line=dict(color="#1d4ed8", width=2.5), marker=dict(size=5),
            ))
            if len(changed_df) > 0:
                fig_trend.add_trace(go.Scatter(
                    x=changed_df["collected_at"], y=changed_df["intr_rate2"],
                    mode="markers", name="ê¸ˆë¦¬ ë³€ë™ ì‹œì ",
                    marker=dict(color="#ef4444", size=12, symbol="star"),
                ))
            fig_trend.update_layout(
                plot_bgcolor="white", paper_bgcolor="white",
                legend=dict(orientation="h", y=1.1, x=1, xanchor="right"),
                yaxis=dict(ticksuffix="%", gridcolor="#f1f5f9", title="ê¸ˆë¦¬ (%)"),
                xaxis=dict(title="ìˆ˜ì§‘ ë‚ ì§œ", gridcolor="#f1f5f9"),
                margin=dict(l=10,r=10,t=30,b=10), height=400,
            )
            st.plotly_chart(fig_trend, use_container_width=True)

            # â”€â”€ ê¸ˆë¦¬ ë³€ë™ ì´ë ¥ í…Œì´ë¸” (ì´ì „ ìˆ˜ì¹˜ â†’ í˜„ì¬ ìˆ˜ì¹˜ í¬í•¨) â”€â”€
            st.markdown('<div class="section-title">ê¸ˆë¦¬ ë³€ë™ ì´ë ¥</div>', unsafe_allow_html=True)
            if len(changed_df) == 0:
                st.info("ì¡°íšŒ ê¸°ê°„ ë‚´ ê¸ˆë¦¬ ë³€ë™ ì´ë ¥ì´ ì—†ìŠµë‹ˆë‹¤.")
            else:
                change_rows = []
                for idx in changed_df.index:
                    prev_idx = idx - 1
                    curr = trend_df.loc[idx]
                    prev = trend_df.loc[prev_idx]

                    base_diff = curr["intr_rate"]  - prev["intr_rate"]
                    max_diff  = curr["intr_rate2"] - prev["intr_rate2"]

                    change_rows.append({
                        "ê¸°ì¤€ì¼ (ì´ì „)":    prev["collected_at"].strftime("%Y-%m-%d"),
                        "ë³€ë™ì¼ (í˜„ì¬)":    curr["collected_at"].strftime("%Y-%m-%d"),
                        "ê¸°ë³¸ê¸ˆë¦¬ ì´ì „(%)": f"{prev['intr_rate']:.2f}%",
                        "ê¸°ë³¸ê¸ˆë¦¬ í˜„ì¬(%)": f"{curr['intr_rate']:.2f}%",
                        "ê¸°ë³¸ê¸ˆë¦¬ ë³€ë™":    f"{'+' if base_diff >= 0 else ''}{base_diff:.2f}%p",
                        "ìµœëŒ€ê¸ˆë¦¬ ì´ì „(%)": f"{prev['intr_rate2']:.2f}%",
                        "ìµœëŒ€ê¸ˆë¦¬ í˜„ì¬(%)": f"{curr['intr_rate2']:.2f}%",
                        "ìµœëŒ€ê¸ˆë¦¬ ë³€ë™":    f"{'+' if max_diff >= 0 else ''}{max_diff:.2f}%p",
                    })

                change_display = pd.DataFrame(change_rows)
                st.dataframe(change_display, use_container_width=True, height=250)

            # ìë™ ìš”ì•½
            first_max  = trend_df["intr_rate2"].iloc[0]
            latest_max = trend_df["intr_rate2"].iloc[-1]
            rate_delta = latest_max - first_max
            direction  = "ìƒìŠ¹" if rate_delta > 0 else ("í•˜ë½" if rate_delta < 0 else "ë³€ë™ ì—†ìŒ")
            date_range = f"{trend_df['collected_at'].min().strftime('%Y-%m-%d')} ~ {trend_df['collected_at'].max().strftime('%Y-%m-%d')}"

            st.markdown(f"""
            <div class="insight-box">
                ğŸ“Œ <b>ê²°ê³¼ ìš”ì•½</b><br>
                <b>{sel_bank_hist} Â· {sel_prod_hist} ({sel_trm_hist}ê°œì›”)</b><br>
                ì¡°íšŒ ê¸°ê°„: <b>{date_range}</b> (ì´ {len(trend_df)}ì¼ ìˆ˜ì§‘)<br>
                ìµœëŒ€ê¸ˆë¦¬: <b>{first_max:.2f}%</b> â†’ <b>{latest_max:.2f}%</b>
                (<b>{'+' if rate_delta >= 0 else ''}{rate_delta:.2f}%p {direction}</b>)<br>
                ê¸ˆë¦¬ ë³€ë™ íšŸìˆ˜: <b>{len(changed_df)}íšŒ</b>
                {"Â· âš ï¸ ìµœê·¼ ê¸ˆë¦¬ê°€ ìƒìŠ¹ ì¤‘ì´ë¯€ë¡œ ê²½ìŸë ¥ ëª¨ë‹ˆí„°ë§ì´ í•„ìš”í•©ë‹ˆë‹¤." if rate_delta > 0 else ""}
            </div>
            """, unsafe_allow_html=True)

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# TAB 4: ì „ì²´ ë°ì´í„°
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
with tabs[3]:
    st.markdown("### ğŸ“‹ ì „ì²´ ë°ì´í„°")
    st.markdown('<div class="desc-box">í•„í„°ê°€ ì ìš©ëœ ì „ì²´ ë°ì´í„°ë¥¼ í™•ì¸í•˜ê³  CSVë¡œ ë‹¤ìš´ë¡œë“œí•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</div>', unsafe_allow_html=True)

    display_cols = list(COL.values())
    rename_map = {v: k for v, k in zip(display_cols, [
        "ìƒí’ˆíƒ€ì…", "ìš°ë¦¬ì€í–‰ìƒí’ˆ", "ì €ì¶•ê¸°ê°„(ì›”)", "íƒ€í–‰ëª…", "íƒ€í–‰ìƒí’ˆëª…",
        "ìš°ë¦¬ ê¸°ë³¸ê¸ˆë¦¬", "ìš°ë¦¬ ìµœëŒ€ê¸ˆë¦¬", "íƒ€í–‰ ê¸°ë³¸ê¸ˆë¦¬", "íƒ€í–‰ ìµœëŒ€ê¸ˆë¦¬",
        "ê¸ˆë¦¬ì°¨(%p)", "ìš°ëŒ€ë‚œì´ë„", "ìš°ëŒ€ì¡°ê±´"
    ])}
    styled_df = (
        fdf[display_cols].rename(columns=rename_map)
        .sort_values("ê¸ˆë¦¬ì°¨(%p)", ascending=False)
        .reset_index(drop=True)
    )
    st.dataframe(
        styled_df.style.format({
            "ìš°ë¦¬ ê¸°ë³¸ê¸ˆë¦¬": "{:.2f}%", "ìš°ë¦¬ ìµœëŒ€ê¸ˆë¦¬": "{:.2f}%",
            "íƒ€í–‰ ê¸°ë³¸ê¸ˆë¦¬": "{:.2f}%", "íƒ€í–‰ ìµœëŒ€ê¸ˆë¦¬": "{:.2f}%",
            "ê¸ˆë¦¬ì°¨(%p)": "+{:.2f}%p",
        }),
        use_container_width=True, height=500,
    )
    csv = styled_df.to_csv(index=False).encode("utf-8-sig")
    st.download_button("â¬‡ï¸ CSV ë‹¤ìš´ë¡œë“œ", csv, "bank_rate_comparison.csv", "text/csv")
